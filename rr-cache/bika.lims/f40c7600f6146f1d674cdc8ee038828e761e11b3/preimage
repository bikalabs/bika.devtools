<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:tal="http://xml.zope.org/namespaces/tal"
    xmlns:metal="http://xml.zope.org/namespaces/metal"
    xmlns:i18n="http://xml.zope.org/namespaces/i18n"
    metal:use-macro="here/main_template/macros/master"
    i18n:domain="bika">

<head>
    <metal:block fill-slot="javascript_head_slot"
        tal:define="portal context/@@plone_portal_state/portal;">
    <script type="text/javascript"
        tal:attributes="src python:portal.absolute_url() + '/bika_widgets/datetimewidget.js'"></script>
    </metal:block>
</head>

<body>

<metal:title fill-slot="content-title">
<h1>
    <img tal:condition="view/icon | nothing" tal:attributes="src view/icon"/>
    <tal:new i18n:translate="">Request new analyses</tal:new>
</h1>
</metal:title>

<div metal:fill-slot="content-core"
    tal:define="
        portal context/@@plone_portal_state/portal;
        plone_view context/@@plone;
        portal_state context/@@plone_portal_state;
        currencies python:modules['zope.i18n.locales'].locales.getLocale('en').numbers.currencies;
        currency python:context.bika_setup.getCurrency();
        checkPermission nocall: context/portal_membership/checkPermission;
        tabindex view/tabindex;
        widget_visibility view/getWidgetVisibility;
        partitionable view/partitioned_services;
        ShowPrices python:context.bika_setup.getShowPrices();">


<form id="analysisrequest_edit_form"
    name="analysisrequest_edit_form"
    method="POST">

<input type="hidden" name="submitted" value="1" />
<span tal:replace="structure context/@@authenticator/authenticator"/>
<input type="hidden" name="came_from" tal:attributes="value view/came_from" />
<input type="hidden" id="template_data" tal:attributes="value view/listTemplates"/>
<input type="hidden" id="profile_data" tal:attributes="value view/listProfiles"/>

<!-- member discount percentage if applicable -->
<input type="hidden" id="member_discount" name="member_discount"
    tal:attributes="value here/bika_setup/getMemberDiscount"
    tal:condition="view/getMemberDiscountApplies"/>

<!-- col_count goes here for the jquery expanding services rows to know how to print themselves -->
<input type="hidden" id="col_count" name="col_count"
    tal:attributes="value view/col_count" />

<!-- These services have partition setup records -->
<input type="hidden" id="partitioned_services" name="partitioned_services"
    tal:attributes="value partitionable" />

<!-- And the current form partition configuration is stored here -->
<input type="hidden" id="parts" name="parts" value="{}"/>

<!-- The system configured 'Dry Matter Service' -->
<tal:i define="dms python:context.bika_setup.getDryMatterService()">
    <input type="hidden" id="getDryMatterService" name="getDryMatterService"
        tal:condition="nocall:dms"
        tal:attributes="
            poc python: dms.getPointOfCapture();
            cat python: dms.getCategoryUID();
            value python: dms.UID();"/>
</tal:i>

<table summary="Add analysis requests"
    class="listing analysisrequest add nosort"
    cellpadding="0" cellspacing="0">
<thead>
    <!-- Contact -->
    <tr tal:define="client_contacts view/getContacts;
                    this_contact python:client_contacts and client_contacts.keys()[0] or ''">
    <th colspan="2" class="rowheader" style="white-space:nowrap">
        <span i18n:translate="">Contact Person</span>
        &nbsp;<span class="fieldRequired">&nbsp;</span>
    </th>

    <td class="contact"
        tal:attributes="colspan python: view.col_count+2">

        <tal:default_ccs
            tal:repeat="key client_contacts">
            <span
                tal:define="value python: client_contacts.getValue(key);
                            ccs python:view.getCCsForContact(contact_uid=key, json=False);"
                style="display:none"
                tal:attributes="
                    uid python:key;
                    title python:value;
                    cc_titles python:','.join([x['title'] for x in ccs]);
                    cc_uids python:','.join([x['uid'] for x in ccs]);">
        </span>
        </tal:default_ccs>

        <select
            name="Contact"
            id="primary_contact"
            tal:attributes="tabindex tabindex/next;">
            <tal:term
                tal:repeat="key client_contacts">
                <option
                    tal:define="value python:client_contacts.getValue(key);"
                    tal:attributes="
                        value key;
                        selected python:this_contact and key == this_contact
                            and 'selected' or '';"
                    tal:content="python:value">
                </option>
            </tal:term>
        </select>

        <!-- Contact CCs-->
        <tal:ccs define="ccs python:view.getCCsForContact(contact_uid=this_contact, json=False);">
            <input type="button"
                id="open_cc_browser"
                class="button"
                style="padding-top:0px;padding-bottom:0px;"
                value="CC"
                i18n:attributes="value"
                i18n:domain="bika"
                tal:attributes="tabindex tabindex/next;"/>
            <input DISABLED="1" id="cc_titles"
                tal:attributes="value python:this_contact and ','.join([c['title'] for c in ccs]) or ''"/>
            <input type="hidden" id="cc_uids" name="cc_uids"
                tal:attributes="value python:this_contact and ','.join([c['uid'] for c in ccs]) or ''"/>
        </tal:ccs>
    </td>
    </tr>

    <!-- CC Emails -->
    <tr>
        <th colspan="2" style="white-space:nowrap" i18n:translate="">CC Emails</th>
        <td class="contact" tal:attributes="colspan python: view.col_count+2">
            <input style="width:98%" type="text" id="cc_emails" name="CCEmails"
                tal:attributes="value python:hasattr(context, 'CCEmails') and context.CCEmails or '';
                    tabindex tabindex/next;"/>
        </td>
    </tr>

<<<<<<<

    <!-- Client selector for contexts with resolvable client -->
    <tal:got_client tal:condition="python:context.portal_type == 'Client' or hasattr(context, 'getClientID')"
                    tal:repeat="column python:range(view.col_count)"
                    tal:define="field_name string:ClientID">
        <tal:block repeat="column python:range(view.col_count)">
            <tal:define define="ClientID python:context.getClientID();
                                ClientUID python:context.UID() if context.portal_type == 'Client' else context.getClientUID();
                                input_name string:ar.${column}.${field_name}:ignore_empty:record;
                                input_id string:ar_${column}_${field_name};
                                hidden_name string:ar.${column}.ClientUID:ignore_empty:record;
                                hidden_id string:ar_${column}_ClientUID;">
                <input
                    type="hidden"
                    tal:attributes="class field_name;
                                    column column;
                                    id input_id;
                                    name input_name;
                                    value ClientID"/>
                <input
                    type="hidden"
                    tal:attributes="class field_name;
                                    column column;
                                    id hidden_id;
                                    name hidden_name;
                                    value ClientUID"/>
            </tal:define>
        </tal:block>
    </tal:got_client>
    <tal:got_primaryreferrer tal:condition="python:context.portal_type == 'Patient' and context.getPrimaryReferrer()"
                    tal:repeat="column python:range(view.col_count)"
                    tal:define="field_name string:ClientID">
        <tal:block repeat="column python:range(view.col_count)">
            <tal:define define="ClientID python:context.getPrimaryReferrer().getClientID();
                                ClientUID python:context.getPrimaryReferrer().UID();
                                input_name string:ar.${column}.${field_name}:ignore_empty:record;
                                input_id string:ar_${column}_${field_name};
                                hidden_name string:ar.${column}.ClientUID:ignore_empty:record;
                                hidden_id string:ar_${column}_ClientUID;">
                <input
                    type="hidden"
                    tal:attributes="class field_name;
                                    column column;
                                    id input_id;
                                    name input_name;
                                    value ClientID"/>
                <input
                    type="hidden"
                    tal:attributes="class field_name;
                                    column column;
                                    id hidden_id;
                                    name hidden_name;
                                    value ClientUID"/>
            </tal:define>
        </tal:block>
    </tal:got_primaryreferrer>
    <tal:got_no_client tal:condition="python:context.portal_type != 'Client'
                                             and not hasattr(context, 'getClientID')
                                             and not context.portal_type == 'Patient'
                                             and not context.getPrimaryReferrer()"
                       tal:define="field_name string:ClientID">
        <!-- Client selector -->
        <tr tal:define="field_name string:ClientID">
            <th colspan="2" class="rowheader" style="white-space:nowrap">
                <span i18n:translate="">Client</span>
                &nbsp;<span class="fieldRequired">&nbsp;</span>
            </th>
=======
    <!-- All edit fields with fields with add=visible -->
    <tr tal:repeat="fieldName python:widget_visibility.get('add', {}).get('visible', [])">
        <tal:def define="
            field python:context.Schema()[fieldName];
            field_macro here/widgets/field/macros/edit;
            accessor python:field.getAccessor(context);
            widget python:field.widget;
            errors python:{};
            mode string:edit;">
            <th colspan="2" style="white-space:nowrap">
                <label class="formQuestion">
                <span tal:replace="python:widget.Label(here)"
                      i18n:translate="" />
                <span class="fieldRequired"
                      tal:condition="field/required"
                      title="Required"
                      i18n:attributes="title title_required;">&nbsp;</span>
                 <em style="display:block"
                       class="discreet"
                     tal:define="description python:widget.Description(here)"
                     tal:content="structure description"
                     tal:attributes="id string:${fieldName}_help"
                     i18n:translate="">Help </em>
                </label>

           </th>
>>>>>>>
            <td>
            <img tal:condition="python:view.col_count > 1"
                 tal:attributes="name fieldName;
                                 class string:copyButton ${fieldName}CopyButton;
                                 src string:${portal/absolute_url}/++resource++bika.lims.images/copy.png;"/>
            </td>
            <tal:columns tal:repeat="column python:range(view.col_count)">
                <td tal:attributes="column column;
                                    ar_add_column_widget string:1">

                   <metal:field use-macro="python:context.widget(fieldName, mode='edit')"/>

                    <tal:hidden_def
                        tal:repeat="hiddenfieldName python:widget_visibility.get('add', {}).get('hidden', [])"
                        tal:define="index repeat/fieldName/index">
                            <!-- All hidden fields -->
                            <input
                                tal:condition="python:index==1"
                                type="hidden"
                                tal:define="val python:context.Schema()[hiddenfieldName].getAccessor(context)();"
                                tal:attributes="
                                    name string:${hiddenfieldName};
                                    id string:${hiddenfieldName};
                                    value val/Title|nothing;"/>
                             <input
                                tal:condition="python:index==1"
                                type="hidden"
                                tal:define="val python:context.Schema()[hiddenfieldName].getAccessor(context)();"
                                tal:attributes="
                                    name string:${hiddenfieldName}_uid;
                                    id string:${hiddenfieldName}_uid;
                                    value val/UID|nothing;"/>
                    </tal:hidden_def>

<<<<<<<
                </td>
            </tal:columns>
        </tal:def>
=======
    <!-- Patient selector -->
    <tal:patient
        define="field_name string:PatientID;
                PatientID python:hasattr(context, 'getPatientID') and context.getPatientID() or '';
                PatientUID python:hasattr(context, 'getPatientUID') and context.getPatientUID() or '';
                PatientUID python:context.portal_type == 'Patient' and context.UID() or PatientUID;">
        <tr tal:condition="python:not PatientID">
            <th colspan="2" style="white-space:nowrap">
                <span i18n:translate="">Patient</span>
                <a style="border-bottom:none !important;margin-left:1em;"
                   class='add_patient'
                   tal:attributes="href string:${portal/absolute_url}/patients/portal_factory/Patient/new/edit?PrimaryReferrer=${context/UID}"
                   rel="#overlay">
                   <img style="padding-bottom:2px;" tal:attributes="src string:${portal/absolute_url}/++resource++bika.lims.images/add.png"/>
                </a>
            </th>
            <td>
                <img class="copyButton PatientIDCopyButton"
                     tal:attributes="name field_name;src string:${portal/absolute_url}/++resource++bika.lims.images/copy.png"/>
            </td>
            <tal:block repeat="column python:range(view.col_count)">
                <td class="topborder ar_column" style="padding-top:2px;"
                    tal:define="
                        input_name string:ar.${column}.${field_name}:ignore_empty:record;
                        input_id string:ar_${column}_${field_name};
                        hidden_name string:ar.${column}.PatientUID:ignore_empty:record;
                        hidden_id string:ar_${column}_PatientUID;">
                <div style="width:100px; border:none;text-align:left;padding-left:2px;">
                <input tal:attributes="
                    class field_name;
                    column column;
                    id input_id;
                    value PatientID;
                    name input_name;"
                    style="width:96px; position:absolute; z-index:+1;"/>
                <input type="hidden" tal:attributes="
                    column column;
                    value PatientUID;
                    id hidden_id;
                    name hidden_name;"/>
                </div>
                </td>
            </tal:block>
        </tr>
        <tal:block condition="python:PatientID" repeat="column python:range(view.col_count)">
            <tal:define define="
                        input_name string:ar.${column}.${field_name}:ignore_empty:record;
                        input_id string:ar_${column}_${field_name};
                        hidden_name string:ar.${column}.PatientUID:ignore_empty:record;
                        hidden_id string:ar_${column}_PatientUID;">
                <input
                    type="hidden"
                    tal:condition="PatientID"
                    tal:attributes="
                        class field_name;
                        column column;
                        id input_id;
                        value PatientID;
                        name input_name;"/>
                <input
                    type="hidden"
                    tal:attributes="
                        column column;
                        value PatientUID;
                        id hidden_id;
                        name hidden_name;"/>
            </tal:define>
        </tal:block>
    </tal:patient>

    <!-- Doctor -->
    <tal:doctor
        define="field_name string:DoctorID;
                DoctorID python:hasattr(context, 'getDoctorID') and context.getDoctorID() or '';
                DoctorUID python:hasattr(context, 'getDoctorUID') and context.getDoctorUID() or ''">
        <tr tal:condition="python:not DoctorID">
            <th colspan="2" style="white-space:nowrap">
                <span i18n:translate="">Doctor</span>
                <a style="border-bottom:none !important;margin-left:1em;"
                   class='add_doctor'
                   tal:attributes="href string:${portal/absolute_url}/doctors/portal_factory/Doctor/new/edit"
                   rel="#overlay">
                   <img style="padding-bottom:2px;" tal:attributes="src string:${portal/absolute_url}/++resource++bika.lims.images/add.png"/>
                </a>
            </th>
            <td>
                <img class="copyButton DoctorIDCopyButton"
                    tal:attributes="name field_name;src string:${portal/absolute_url}/++resource++bika.lims.images/copy.png"/>
            </td>
            <tal:block repeat="column python:range(view.col_count)">
                <td class="topborder ar_column" style="padding-top:2px;"
                    tal:define="
                        input_name string:ar.${column}.${field_name}:ignore_empty:record;
                        input_id string:ar_${column}_${field_name};
                        hidden_name string:ar.${column}.DoctorUID:ignore_empty:record;
                        hidden_id string:ar_${column}_DoctorUID;">
                <div style="width:100px; border:none;text-align:left;padding-left:2px;">
                <input tal:attributes="
                    class field_name;
                    column column;
                    id input_id;
                    value DoctorID;
                    name input_name;"
                    style="width:96px; position:absolute; z-index:+1;"/>
                <input type="hidden" tal:attributes="
                    class string:${field_name};
                    column column;
                    id hidden_id;
                    value DoctorUID;
                    name hidden_name;"/>
                </div>
                </td>
            </tal:block>
        </tr>
        <tal:block condition="python:DoctorID" repeat="column python:range(view.col_count)">
            <tal:define define="
                        input_name string:ar.${column}.${field_name}:ignore_empty:record;
                        input_id string:ar_${column}_${field_name};
                        hidden_name string:ar.${column}.DoctorUID:ignore_empty:record;
                        hidden_id string:ar_${column}_DoctorUID;">
                <input
                    type="hidden"
                    tal:condition="DoctorID"
                    tal:attributes="
                        class field_name;
                        column column;
                        id input_id;
                        value DoctorID;
                        name input_name;"/>
                <input
                    type="hidden"
                    tal:attributes="
                        column column;
                        value DoctorUID;
                        id hidden_id;
                        name hidden_name;"/>
            </tal:define>
        </tal:block>
    </tal:doctor>

    <!-- AR Template (only visible and useable for AR-Add-->
    <tr tal:define="field_name string:ARTemplate">
        <th colspan="2" style="white-space:nowrap" i18n:translate="">Template</th>
        <td>
            <img class="copyButton ARTemplateCopyButton"
                 tal:condition="python:view.col_count > 1"
                 tal:attributes="name field_name;src string:${portal/absolute_url}/++resource++bika.lims.images/copy.png"/>
        </td>
        <tal:block repeat="column python:range(view.col_count)">
            <td class="topborder ar_column" style="padding-top:2px;"
                tal:define="input_name string:ar.${column}.${field_name}:ignore_empty:record;
                input_id string:ar_${column}_${field_name}">
            <div style="width:100px; border:none;text-align:left;padding-left:2px;">
            <select tal:attributes="
                class field_name;
                column column;
                id input_id;
                name input_name;"
                style="width:96px; position:absolute; z-index:+1;"
                onactivate="this.style.width='auto';"
                onchange="this.blur();"
                onblur="this.style.width='96px';">
                <option value="" i18n:translate=""></option>
                <tal:template repeat="template view/artemplates">
                    <option
                        tal:content="python:template[0]"
                        tal:attributes="
                            value python:template[1].UID();"></option>
                </tal:template>
            </select>
            </div>
            </td>
        </tal:block>
    </tr>
    <!-- Analysis Profile (only visible and useable for AR-Add-->
    <tr tal:define="field_name string:AnalysisProfile">
        <th colspan="2" style="white-space:nowrap" i18n:translate="">Profile</th>
        <td>
            <img class="copyButton AnalysisProfileCopyButton"
                 tal:condition="python:view.col_count > 1"
                 tal:attributes="name field_name;src string:${portal/absolute_url}/++resource++bika.lims.images/copy.png"/>
        </td>
        <tal:block repeat="column python:range(view.col_count)">
            <td class="topborder ar_column" style="padding-top:2px;"
                tal:define="input_name string:ar.${column}.${field_name}:ignore_empty:record;
                input_id string:ar_${column}_${field_name}">
            <div style="width:100px; border:none;text-align:left;padding-left:2px;">
            <select tal:attributes="
                class field_name;
                column column;
                id input_id;
                name input_name;"
                style="width:96px; position:absolute; z-index:+1;"
                onactivate="this.style.width='auto';"
                onchange="this.blur();"
                onblur="this.style.width='96px';">
                <option value="" i18n:translate=""></option>
                <tal:profile repeat="profile view/analysisprofiles">
                    <option
                        tal:content="python:profile[0]"
                        tal:attributes="
                            value python:profile[1].UID();"></option>
                </tal:profile>
            </select>
            </div>
            </td>
        </tal:block>
>>>>>>>
    </tr>
</thead>

<thead class="pointofcapture">
    <tr>
        <th style='padding-left:0;'
            tal:attributes="colspan python:view.col_count + 3">
            <input class="context button allowMultiSubmit"
                type="submit"
                name="save_button"
                i18n:attributes="value"
                value="Save"/>
        </th>
<<<<<<<
        <td>
            <img class="copyButton SampleTypeCopyButton"
                 tal:condition="python:view.col_count > 1"
                 tal:attributes="name field_name;src string:${portal/absolute_url}/++resource++bika.lims.images/copy.png"/>
        </td>
        <tal:block repeat="column python:range(view.col_count)">
            <td tal:define="input_name string:ar.${column}.${field_name}:ignore_empty:record;
                input_id string:ar_${column}_${field_name}">
            <input size="10" type='text' class='sampletype' value=""
                tal:attributes="
                    id input_id;name input_name;
                    tabindex python:column*100+tabindex.next();"/>
            </td>
        </tal:block>
    </tr>
    <!-- Sampling Deviation -->
    <tr tal:define="field_name string:SamplingDeviation">
        <th colspan="2" style="white-space:nowrap" i18n:translate="">Sampling Deviation</th>
        <td>
            <img class="copyButton SamplingDeviationCopyButton"
                 tal:condition="python:view.col_count > 1"
                 tal:attributes="name field_name;src string:${portal/absolute_url}/++resource++bika.lims.images/copy.png"/>
        </td>
        <tal:block repeat="column python:range(view.col_count)">
            <td class="topborder ar_column" style="padding-top:2px;"
                tal:define="input_name string:ar.${column}.${field_name}:ignore_empty:record;
                input_id string:ar_${column}_${field_name}">
            <div style="width:100px; border:none;text-align:left;padding-left:2px;">
            <select
                tal:attributes="
                class field_name;
                column column;
                id input_id;
                name input_name;"
                style="width:96px; position:absolute; z-index:+1;"
                onactivate="this.style.width='auto';"
                onchange="this.blur();"
                onblur="this.style.width='96px';">
                <option value="" i18n:translate=""></option>
                <tal:samplingdeviations repeat="sd view/samplingdeviations">
                    <option
                        tal:content="python:sd[0]"
                        tal:attributes="
                            value python:sd[1].UID();"></option>
                </tal:samplingdeviations>
            </select>
            </div>
            </td>
        </tal:block>
    </tr>
    <!-- Default Container Type -->
    <tr tal:define="field_name string:DefaultContainerType"
            tal:condition="python: context.portal_type != 'Batch'">
        <th colspan="2" style="white-space:nowrap" i18n:translate="">Default Container Type</th>
        <td>
            <img class="copyButton DefaultContainerTypeCopyButton"
                 tal:condition="python:view.col_count > 1"
                 tal:attributes="name field_name;src string:${portal/absolute_url}/++resource++bika.lims.images/copy.png"/>
        </td>
        <tal:block repeat="column python:range(view.col_count)">
            <td class="topborder ar_column" style="padding-top:2px;"
                tal:define="input_name string:ar.${column}.${field_name}:ignore_empty:record;
                input_id string:ar_${column}_${field_name}">
            <div style="width:100px; border:none;text-align:left;padding-left:2px;">
            <select
                tal:attributes="
                class field_name;
                column column;
                id input_id;
                name input_name;"
                style="width:96px; position:absolute; z-index:+1;"
                onactivate="this.style.width='auto';"
                onchange="this.blur();"
                onblur="this.style.width='96px';">
                <option value="" i18n:translate=""></option>
                <tal:containertypes repeat="o view/containertypes">
                    <option
                        tal:content="python:o[0]"
                        tal:attributes="
                            value python:o[1].UID();"></option>
                </tal:containertypes>
            </select>
            </div>
            </td>
        </tal:block>
    </tr>
    <!-- Ad-Hoc -->
<!--     <tr tal:define="field_name string:AdHoc"
        tal:condition="python: context.portal_type != 'Batch'">
        <th colspan="2" style="white-space:nowrap" i18n:translate="">Ad-Hoc</th>
        <td>
            <img class="copyButton"
                 tal:condition="python:view.col_count > 1"
                 tal:attributes="name field_name;src string:${portal/absolute_url}/++resource++bika.lims.images/copy.png"/>
        </td>
        <tal:block repeat="column python:range(view.col_count)">
            <td class="cb"
                tal:define="input_name string:ar.${column}.${field_name}:ignore_empty:record;
                    input_id string:ar_${column}_${field_name}">
            <input type="checkbox"
                class="cb"
                value="checked"
                tal:attributes="
                    column column;
                    name input_name;
                    id input_id;
                    tabindex python:column*100+tabindex.next();"/>
            </td>
        </tal:block>
    </tr> -->
    <!-- Composite -->
<!--     <tr tal:define="field_name string:Composite"
        tal:condition="python: context.portal_type != 'Batch'">
        <th colspan="2" style="white-space:nowrap" i18n:translate="">Composite</th>
        <td>
            <img class="copyButton"
                 tal:condition="python:view.col_count > 1"
                 tal:attributes="name field_name;src string:${portal/absolute_url}/++resource++bika.lims.images/copy.png"/>
        </td>
        <tal:block repeat="column python:range(view.col_count)">
            <td class="cb"
                tal:define="input_name string:ar.${column}.${field_name}:ignore_empty:record;
                    input_id string:ar_${column}_${field_name}">
            <input type="checkbox"
                class="cb"
                value="checked"
                tal:attributes="
                    column column;
                    name input_name;
                    id input_id;
                    tabindex python:column*100+tabindex.next();"/>
            </td>
        </tal:block>
    </tr> -->
    <!-- Dry Matter -->
    <tr tal:define="field_name string:ReportDryMatter"
        tal:condition="python:context.bika_setup.getDryMatterService()">
        <th colspan="2" style="white-space:nowrap" i18n:translate="">Report as Dry Matter</th>
        <td>
            <img class="copyButton"
                 tal:condition="python:view.col_count > 1"
                 tal:attributes="name field_name;src string:${portal/absolute_url}/++resource++bika.lims.images/copy.png"/>
        </td>
        <tal:block repeat="column python:range(view.col_count)">
            <td class="cb"
                tal:define="input_name string:ar.${column}.${field_name}:ignore_empty:record;
                    input_id string:ar_${column}_${field_name}">
            <input type="checkbox"
                class="cb ReportDryMatter"
                value="checked"
                tal:attributes="
                    column column;
                    name input_name;
                    id input_id;
                    tabindex python:column*100+tabindex.next();"/>
            </td>
        </tal:block>
    </tr>
    <!-- Exclude from Invoice -->
<!--     <tr tal:define="field_name string:InvoiceExclude"
        tal:condition="python:context.portal_type != 'Batch'">
        <th colspan="2" style="white-space:nowrap" i18n:translate="">Exclude from invoice</th>
        <td>
            <img class="copyButton"
                 tal:condition="python:view.col_count > 1"
                 tal:attributes="name field_name;src string:${portal/absolute_url}/++resource++bika.lims.images/copy.png"/>
        </td>
        <tal:block repeat="column python:range(view.col_count)">
            <td class="cb"
                tal:define="input_name string:ar.${column}.${field_name}:ignore_empty:record;
                    input_id string:ar_${column}_${field_name}">
            <input type="checkbox"
                class="cb"
                value="checked"
                tal:attributes="
                    name input_name;
                    column column;
                    id input_id;
                    tabindex python:column*100+tabindex.next();"/>
            </td>
        </tal:block>
    </tr> -->
=======
    </tr>
>>>>>>>
</thead>

<!-- Analyses -->
<tal:i define="
    cats view/Categories;
    POINTS_OF_CAPTURE python: modules['bika.lims.config'].POINTS_OF_CAPTURE;">
    <tal:i repeat="poc python:['field', 'lab']">
    <tal:has_poc tal:condition="python:poc in cats">
        <thead class="pointofcapture"
            tal:attributes="id poc">
            <tr>
                <th tal:attributes="colspan python:view.col_count + 3">
                    <img title="analyses"
                        tal:attributes="src string:${portal/absolute_url}/++resource++bika.lims.images/analysisservice.png"/>
                <span tal:content="python:POINTS_OF_CAPTURE.getValue(poc)"/>
                </th>
            </tr>
        </thead>

    <tal:i tal:define="sortedcats python:cats[poc];
        dummy python:sortedcats.sort(lambda x, y: cmp(x[1], y[1]))"
    repeat="cat sortedcats">
    <thead>
        <tr class="analysiscategory">
            <th tal:content="python:cat[1]"
                tal:define="add_prefill python:cat[0] in view.DefaultCategories();"
                tal:attributes="
                    id python:'cat_%s_%s'%(poc, cat[1]);
                    colspan python:view.col_count + 3;
                    poc poc;
                    cat python:cat[0];
                    class python: 'analysiscategory collapsed %s' % (add_prefill and ' prefill' or '')"/>

    </tr>
</thead>
<tbody class="analysisservices" tal:attributes="
    id python:poc + '_' + cat[0]">
    <tr></tr>
</tbody>
</tal:i>
</tal:has_poc>
</tal:i>
</tal:i>


<tfoot tal:condition="ShowPrices">

    <!-- Pretty blank row -->
    <thead class="pointofcapture"><tr><th tal:attributes="colspan python:view.col_count + 3">&nbsp;</th></tr></thead>

    <tr tal:condition="python:view.getMemberDiscountApplies() and ShowPrices">
        <th class="topborder" colspan="2">
            <b i18n:translate="">Discount</b>
            <span class="discreet">(<tal:i content="here/bika_setup/getMemberDiscount"/>%)</span>
        </th>
        <th class="topborder noleftborder" style="text-align:center">
            <span tal:replace="python:currencies[currency].symbol"/>
        </th>
        <tal:block repeat="column python:range(view.col_count)">
            <td class="topborder" tal:define="input_id string:ar_${column}_discount;">
                <input class="price noborder" size="10" disabled="disabled" value="0.00"
                    tal:attributes="id input_id;" />
            </td>
        </tal:block>
    </tr>

    <tr>
        <th class="topborder" colspan="2"><b i18n:translate="">Subtotal</b></th>
        <th class="topborder noleftborder" style="text-align:center">
            <span tal:replace="python:currencies[currency].symbol"/>
        </th>
        <tal:block repeat="column python:range(view.col_count)">
            <td class="topborder" tal:define="input_id string:ar_${column}_subtotal;
                input_name string:ar.${column}.subtotal">
            <input class="price noborder" size="10" disabled="disabled" value="0.00"
                tal:attributes="id string:${input_id}_display;"/>
            <input type="hidden"
                tal:attributes="
                    id input_id;
                    name string:${input_name}:record:ignore_empty;"/>
            </td>
        </tal:block>
    </tr>

    <tr>
        <th colspan="2" class="topborder"><b i18n:translate="">VAT</b></th>
        <th class="topborder noleftborder" style="text-align:center">
            <span tal:replace="python:currencies[currency].symbol"/>
        </th>
        <tal:block repeat="column python:range(view.col_count)">
            <td class="topborder" tal:define="input_id string:ar_${column}_vat;
                input_name string:ar.${column}.vat">
            <input class="price noborder" size="10" disabled="disabled" value="0.00"
                tal:attributes="id string:${input_id}_display;"/>
            <input type="hidden"
                tal:attributes="
                    id input_id;
                    name string:${input_name}:record:ignore_empty;"/>
            </td>
        </tal:block>
    </tr>

    <tr>
        <th class="topborder" colspan="2"><b i18n:translate="">Total</b></th>
        <th class="topborder noleftborder" style="text-align:center">
            <span tal:replace="python:currencies[currency].symbol"/>
        </th>
        <tal:block repeat="column python:range(view.col_count)">
            <td class="topborder" tal:define="
                input_id string:ar_${column}_total;
                input_name string:ar.${column}.total">
            <input class="price noborder" size="10" disabled="disabled" value="0.00"
                tal:attributes="id string:${input_id}_display;"/>
            <input type="hidden"
                tal:attributes="
                    id input_id;
                    name string:${input_name}:record:ignore_empty;"/>
            </td>
        </tal:block>
    </tr>
</tfoot>
</table>

    <input class="context button allowMultiSubmit"
        type="submit"
        name="save_button"
        i18n:attributes="value"
        value="Save"/>

    <br/>&nbsp;

    <div class="discreeter">

    <p>  <!-- AVS this should be conditional if any dryables present -->
        <img src="" tal:attributes="src string:${portal/absolute_url}/++resource++bika.lims.images/dry.png">
        <span i18n:translate="">
            Can be reported as dry matter</span>
    </p>

    <!-- XXX this also -->
    <p tal:condition="python:context.bika_setup.laboratory.getLaboratoryAccredited()">
        <img tal:attributes="src string:${portal/absolute_url}/++resource++bika.lims.images/accredited.png">
        <span i18n:translate="">
            Methods included in the
                <tal:block
                    replace="here/bika_setup/laboratory/AccreditationBody"
                    i18n:name="accreditation_body"/>
            schedule of Accreditation for this Laboratory.
            Analysis remarks are not accredited
        </span>
    </p>
    </div>

    </form>
</div>
</body>
</html>
